# 1.4.7 feat2 - 게임 흐름 및 로딩 프로세스 개선 보고서

## 1. 개요 (Overview)
*   **문서 목적:** 1.4.7 버전에서 발생한 게임 흐름(Flow) 및 로딩 화면 처리 이슈를 분석하고, 명확한 수정 방향을 정의합니다.
*   **배경:** 최근 로딩 페이즈 최적화(에셋 사전 생성 및 캐싱) 작업 이후, 게임 진입 시 UI가 그려지지 않거나 로딩 화면이 너무 빨리 사라지는 등 UX 저하가 발생했습니다.
*   **목표:** 모든 진입 경로(최초 접속, 재시작, 새로고침 등)에서 **"모든 UI와 에셋이 배치 완료된 상태"**를 보장한 뒤 로딩 화면을 제거하도록 로직을 개선합니다.

## 2. 진입 시나리오 분석 (Scenario Analysis)

사용자의 게임 진입 경로는 크게 세 가지이며, 접속 환경에 따라 두 가지 상황으로 나뉩니다.

### 2.1. 게임 시작 경로 (User Journey)
*   **A-1. 빠른 시작:** 로비 -> [바로 시작]
*   **A-2. 방 생성:** 로비 -> [방 만들기] -> [생성]
*   **A-3. 코드 입장:** 로비 -> [코드로 입장] -> 코드 입력 -> [입장]

### 2.2. 접속 환경 (Context)
*   **B-1. 최초 접속 (Cold Start):** 브라우저를 열고 처음 사이트에 접속. 에셋 로딩 필요.
*   **B-2. 새로고침/재접속 (Reload):** 브라우저 새로고침 또는 URL 직접 입력. 캐시된 에셋이 있을 수 있음.

---

## 3. 문제 상황 및 원인 (Problems & Root Causes)

### C-1. UI 컴포넌트 미노출 (공통)
*   **현상:** 로딩 화면이 사라진 직후, 게임 화면은 보이지만 핵심 UI(미니맵, 랭킹, 타이머, 컨트롤러 등)가 렌더링되지 않은 상태로 게임이 시작됨.
*   **원인:** 로딩 화면의 종료 조건이 "서버 연결"이나 "에셋 생성"에만 의존하고 있음. **"UI 컴포넌트의 배치 완료"**를 기다리지 않음.

### C-2. 재시작 시 로딩 스킵 (Hot Restart)
*   **현상:** 사망 후 [다시하기] 클릭 시, 로딩 화면이 거의 보이지 않거나 즉시 게임이 시작됨. 방이 바뀌었음에도 전환 효과가 없어 사용자 경험(UX)이 어색함. UI 또한 로딩되지 않음.
*   **원인:** 이미 에셋이 메모리에 로딩되어 있다는 이유로 로딩 과정을 건너뜀. UI 상태 초기화 트리거가 제대로 작동하지 않아, 이전 게임의 "준비 완료" 상태가 유지되고 있을 가능성이 높음.

### C-3. 새로고침 시 동기화 실패
*   **현상:** 새로고침(B-2) 후에도 C-1과 유사하게 UI가 늦게 뜨거나 로딩 타이밍이 맞지 않음.
*   **원인:** `useEffect` 등의 초기화 로직에서 에셋 로딩 상태 확인과 UI 렌더링 시점 간의 레이스 컨디션(Race Condition) 발생.

---

## 4. 개선 방안 (Proposed Solution)

로딩 화면(Loading Screen)은 단순한 시간 때우기가 아니라, **사용자가 플레이할 준비가 완벽히 끝났음을 보장하는 장치**여야 합니다.

### 4.1. 로딩 종료 조건 강화 (Strict Loading Conditions)
로딩 화면을 제거(`setIsLoading(false)`)하기 위해서는 다음 **4가지 조건이 모두 `AND`로 충족**되어야 합니다.

1.  **서버 연결 완료 (Connection Ready):** 소켓 연결 및 `JOIN_GAME` 성공 응답 수신.
2.  **최소 대기 시간 충족 (Minimum Duration):** UX 흐름상 "방이 변경됨"을 인지할 수 있도록 최소 **1초** 이상 로딩 화면 유지.
3.  **에셋 배치 완료 (Assets Placed):** 단순 리소스 로딩을 넘어, 실제 씬(Scene)에 플레이어 및 오브젝트 렌더링 준비 완료.
4.  **UI 마운트 완료 (UI Mounted):** 랭킹, 미니맵, 조작 버튼 등 필수 HUD 컴포넌트가 DOM에 렌더링 완료됨을 확인.

### 4.2. 상태 관리 및 트리거 개선
*   **초기화(Reset) 로직 추가:**
    *   `다시하기` 또는 `로비로 이동` 버튼 클릭 시, 반드시 `isUIReady`, `isSceneReady`와 같은 플래그 변수를 `false`로 초기화해야 합니다.
    *   새 게임 시작 시 이 플래그들이 모두 `true`가 될 때까지 로딩 화면을 유지합니다.
*   **UI 레디 콜백 도입:**
    *   주요 UI 컴포넌트(`HUD`)에 `onMount` 또는 `onReady` 콜백을 추가하여, 부모 컨테이너가 모든 자식 UI의 준비 상태를 확인하도록 구조화합니다.

---
## 5. 주의사항
다음과 같은 상황을 주의하세요.
1. A-2,3와 같은 상황에서 사용자가 사망했을 때, 다시하기를 눌러도 다른 방으로 이동하지 않습니다. 따라서 별도의 로딩 화면 없이 플레이어의 아바타만 재배치해야 합니다. 현재 사설방 로직이 정상적으로 작동하고 있는지를 확인해주세요.
2. 모든 문제 상황 및 원인은 사용자의 개인적인 예측입니다. 따라서 실제 프로세스가 어떻게 진행되는지를 확인 후 개선 작업을 진행해 주세요.
3. 모든 개선 제안은 최고의 선택이 아닐 수 있습니다. 따라서 단순히 개선 제안대로 작업을 진행하는 것이 아닌, 문제 상황이 발생한 원인을 명확히 분석하고 최고의 개선안을 제안해 주세요.
4. 절대 임의로 작업을 진행해선 안됩니다. 사용자의 동의를 얻은 후 작업을 진행해 주세요.

## 6. 출력물
flow_fix_implementaion.md 파일을 생성하여 사용자에게 제공합니다.

